%hr
%a.bookmark.tooltippy{:href => "#", :id => "#{course.id}", :class => (false ? "enabled" : ""), :onclick => "bookmark(this); return false;", :title => "Bookmark this course", :data => {num:"#{course.dept_and_cnum}", name:"#{course.name}", toggle:"tooltip", placement:"left"}}
  %span.glyphicon.glyphicon-bookmark
.box{:class=>(course.cancelled? ? "cancelled" : "")}
  %p.lead
    =surround "#{course.short}", ": #{course.name}" do
      %span.cnum= course.num
  .course-credits
    =course.credits
    credits
  .course-details
    -if course.sister_course_id
      -sister = course.sister_course.decorate
      .info
        %strong Also offered:
        =link_to sister.term_and_year, "/?q=#{sister.dept_and_cnum}&term=#{sister.term}"
    -if course.comments
      .info
        %strong Comments:
        =raw course.comments
    -if course.restrictions
      .info
        %strong Restrictions:
        =course.restrictions
    -if course.has_prereqs?
      .info
        %strong Prerequisites:
        =raw course.prereqs
    -if course.cross_listed
      .info
        %strong Cross listed:
        =raw course.cross_listed
  %p.desc
    =course.desc
  %table.wide
    -num_hidden = 0
    -course.sections.each_with_index do |section,i|
      -section = section.decorate
      -style = ""
      -klass = ""
      -# TODO - this is kind of an ugly way of filtering sections by instructor, but can't really think of another way
      -if should_hide_section?(section)
        -style = "display: none;"
        -klass = "showme"
        -num_hidden += 1
      %tr{:style => style, :class => klass}
        %td.course-btn
          .tooltippy{:style=>"height:auto;",:data => {toggle:"tooltip", placement:"bottom"}, :title => section.add_button_tooltip}
            .btn-group.full.add-course-group
              %button.btn.full.add-course-btn{type:"button", :class => section.add_button_class, onmouseover:"hover(this);", onmouseout:"unhover(this);", data:{section:section.data}}
                =section.button_text("Section")

        %td.course-info
          %p.info
            %strong Time & Place:
            =section.time_and_place
          -if section.instructors
            .info
              %strong
                ="Instructor#{section.multiple_instructors? ? "s" : ""}:"
              -section.instructor_list.each_with_index do |i, idx|
                -if idx > 0
                  ;
                .dropdown.inline
                  %a{href:"#", onclick:"return false;", data:{toggle:"dropdown"}, :class => "dropdown-toggle"}
                    =i
                  =instructor_dropdown(i)
      %tr{:style => style, :class => klass}
        %td{colspan:"2"}
          .progress
            %div.progress-bar{style:"width: #{section.enroll_bar_precentage}%", :class => "progress-bar-#{section.enroll_bar_style}"}

          .progress-num
            %small
              =section.enroll_ratio
              enrolled

  -if num_hidden > 0
    %a{href:"#", onclick:"$(this).parent().find('.showme').show(); $(this).hide(); return false;"} 
      %strong
        Show
        =num_hidden
        more sections

  .subcourses
    -{"lab" => course.labs, "lab lecture" => course.lab_lectures, "recitation" => course.recitations, "workshop" => course.workshops}.each do |name, sections|
      -if !sections.empty?
        .subcourse
          .subcourse-show
            %a{href:"#", onclick:"$(this).parent().parent().find('.subcourse-data').show(); $(this).parent().hide(); return false;"} 
              %strong
                Show
                =sections.size
                =name
                =sections.size == 1 ? "section" : "sections"
          %div.subcourse-data{:style=>"display:none"}
            %p
              %strong
                =name.capitalize
                sections:
              %a{href:"#", onclick:"$(this).parent().parent().parent().find('.subcourse-show').show(); $(this).parent().parent().hide(); return false;"} 
                (hide)
            %div{:class => should_split_cols(sections) ? "cols" : ""}
              %table
                -sections.each do |lab|
                  -lab = lab.decorate
                  %tr
                    %td.middle.center
                      %button.btn.btn-sm.full.lab-btn{type:"button", :class => lab.add_button_class, onmouseover:"hover(this);", onmouseout:"unhover(this);", data:{section:lab.data}}
                        .btn-title
                          =lab.button_text(name.titleize)
                    %td.lab-info
                      .info
                        =lab.time_and_place
                      .info
                        =lab.enroll_ratio
                        students are enrolled
                -if should_split_cols(sections) && sections.size.odd? #add extra if odd to align the columns
                  %tr
                    %td.lab-info
    / WAS in nice neat partials, but that had a significant performance hit
    / =render partial:"subcourse", locals: {sections:course.labs, name:"lab"}
    / =render partial:"subcourse", locals: {sections:course.lab_lectures, name:"lab lecture"}
    / =render partial:"subcourse", locals: {sections:course.recitations, name:"recitation"}
    / =render partial:"subcourse", locals: {sections:course.workshops, name:"workshop"}
