DATA = '__LASTFOCUS=&__EVENTTARGET=ctl00%24MainContentArea%24btnSearch&__EVENTARGUMENT=&__VIEWSTATE=uX2whDNV%2BVBej1QodNj%2FSXZRvFuLz%2BoZZn8H82N7XBud56YD57sFxXZSXq2RRpLLj98HEZ0MhV7HN8rDZ%2BV0KY4t4AzrKoS6TN2zle7fgkibRtkEq1YGXBCOIVJVOe%2FRePzb71UoHTM5%2Bx9cWeYiR%2BvjMlDib0ti%2F2DLLoYgWaBi2FLVZc1xka1j7IB6n5zZlhdckMnk3bGRPsUa9wiqUYSUD2vqbSlc%2FTeX8H4bru33gh26uARjTsLPl9yg4m89kKy89RAfxhJMW5eD%2BQhAWO1SGTlmffnOhIgJIR61J5Skqc0Zb8opIdLXgMIbglU4D3euD12P0TELp19FA1D4NVAByOmLsDrrhIFrc%2FikDkcUKuL3fzsSiT4dyyQ2W6oRvtNfHWQf73hI12pA1KuoNT1rq%2BM%2B2RrC9G667TAcvbcltJBWHVHagGpkkcM2TEEArzuorkSrRWBZ8Sxaclur14lKxZuISEkt%2B8C2EDMUmy4vebqgpvlrGZIi2tmKuRMHDJ%2FAAn8mlqMSHPhbcsQsZ0I%2BUB89A%2FC6xzS%2BqZCzP7KoUKLsL8p5UUHsgXR2ExytfKkJYX1K6k%2F%2FHWQtE0pytPTq6BBGGZK2T1sju5U6IjT4dVGHa5kh6PpKUQWvpq033iUTq12pUbHA6I9SoVxm4i2pgrqkFABwNtmZDpZKAd%2BJRgBRdgQ8HbRDC5KVADJjnMkH07K5ZzJBsTFkOaAq2F34Ev6TjK1Xc03v%2FSPkawOZl61EebYa4mDNQqKUbH1DmViRoZpb%2BE8cR7vgveYW94qYBXFYQcuseCi4BkB8sWBj3FbujqJZQR9MbLtTbiqcyfaOQZ2Bs7p4WL6LPgfpQEjj705nLDdzJ4F8NF0xPtNWpN4dRq%2FmPwUx8PQG9Qbbwr1i43oC8mxb7dfCccQuEAQxBh8oat93Mk27%2BRd5UvqVH1pPqxmuUVon%2BvtRdF3yYUnMXG%2BKNcU%2BSnPBWiqmEjLXf1OqvMd6f8Sx7%2Fp7wAfgqXtDlDhZP%2BgbqjPggU%2B1azKZdbmWXR6P%2F9m1RowaVJhShbVsu8lGRO3PT6zdoJZwj6EPC7Q3Roqdnc9teyNJhSpe%2F23MfHt9fugynGOmgHNnLQo36%2FPc3W6dhaeLHwTj20bWo2RIAna8uBGJVlVkameeWKDyRmooFVOh4NCDELju5pGu8WgMC6aunHlmvCW7r0wQ4KeTErN5VRKPI1WQald50Fb3CPz72w3qWtbQC1c2TdpTrGgUxd9NWBUL84A3%2FJT2x3IqCoLgwAuaboStLQ54zPxDI8R2RMe8Y9IZYXw8XxNva3%2FR3nNV2mIOcHKdBxD8gE0Zka6eVLz4QesGU5gqzrTVd4AxuFt0R5qEXz2m0figXe7sPkctr%2FxmXJYRxV2QphdyR0LHbOd6fhnkk%2Bse817h9Fok5C4m3Hhfx9J0wjinbMNohdlPmmAOY%2Fi5ZuKhmvrtj3w6sNRygALHzUt5FoWJF4V7ZE9IFoeFmmAxU7p8nRnHVAf1mD9zfR7jK99ACzXxkiQuidFl0Db9NacyHs8uoUHPVdz44bLuzWFupLVCo8DH7nwmGI7RC0PaTn6S8uyXPMcq%2BZHdWXQ%2Fl7YVHdt9WQUxYwWaKw5%2BW4nkOIMkspAcm9SsnUUUaJxqGTBiIZOHCui9Xh8MJzabisOFjpAf9Eqkjb6vvVno7YLhxU6n9XffMVghu7ubTjqpnIqPZxaSZB5ae%2B18dQXoXyRMnfYV3ICpyd6Ahwz4iGiaeqRbL7rGjBgLY%2Bx2nA4Zy6K7qPzV7wt8vUcDJKTKqLVtbxuz%2BkYcmfnkQ%2BcrQXVZGb38HySMEYGaY9s0g4sh1lQCFguN8Cxx%2BGML9FVeIsHfAKgnH9MvTgxzm0Ia%2F8WPke0D6qBO9J0H4ipfmNrkZohe6gqw6EoExHGz%2Bn7rhM00uZScY6xCMiQvn2beWdwNMgo6oPOQ0%2BI0iTX7Nt9Ow0Sg3xRmRfULWwkcQuk7XhsoHXjTWwQ8HVFJpepCUlsAnV0JJtGBJigwLtt9i9RNiNtrW3vPL5JO%2FFIstC1UBZN0Cy9DD1hicThWIC1KO9qmG0R2cSdKCOur6dDMN1UjL5ARUDkdfsruIk5X%2BuIvJVhhtw%3D%3D&__VIEWSTATEENCRYPTED=&__EVENTVALIDATION=9mq%2BT%2BK7Fl5dm90Yplit0yCVulECicIf5bGq0mMYDTGHn9BuPVnyf44vumvIOv6PusxFcvtz84m8qNu76pkZncf4wrULTA1%2B0QDHUGE3%2Bzvvp4Mf2mSr1QpfRBN7VGBCP1RmpUCADaiaV7vGOTqFrF%2FkWtRAx327eVl%2FhYTMUEkpAuPz&ctl00%24MainContentArea%24txtNETID=&ctl00%24MainContentArea%24txtPassword=&ctl00%24MainContentArea%24txtDepartment=&ctl00%24MainContentArea%24txtPhone=&ctl00%24MainContentArea%24txtEmail=&ctl00%24MainContentArea%24txtName='

class MainController < ApplicationController
	def get_email
		response = HTTParty.post('https://info.rochester.edu/FacultyStaffDirectory/Default.aspx', :body => DATA+params["email"])
		if match = response.parsed_response.match(/(JpegImage\.ashx\?text=[A-Z0-9]+)/)
			img = "https://info.rochester.edu/FacultyStaffDirectory/"+match[1]
			render json:{"url" => img}
		else
			render status:404
		end
	end

	def params_from_query(query, credits=0, term=0)
		status_search = nil
		name_search = nil
		dept_search = nil
		num_search = nil
		instructor_search = nil

		c_lo, c_hi = [[nil, nil],[1,2],[3,4],[5,nil]][credits.to_i]
		term_search = [nil, 0, 1][term.to_i]

		instructor_regex = /instructor:\s*([A-Za-z'-_]*)/i
		if (match = query.match instructor_regex)
			instructor_search = match[1]
			query = query.gsub(instructor_regex,"").strip #remove from the query
		end

		name_search = query
		match = query.match /^\s*([A-Za-z]{,3})\s*(\d+[A-Za-z]*|)\s*$/
		if match
			dept_search = match[1].upcase if !match[1].empty?
			num_search = match[2] if !match[2].empty?
			name_search = nil
		end

		select = {}
		select[:credits.gte] = c_lo               if c_lo
		select[:credits.lte] = c_hi               if c_hi
		select[:number] = /#{num_search}.*/       if num_search
		select[:dept] = dept_search               if dept_search
		select[:instructors] = instructor_search  if instructor_search
		select[:title] = /.*#{query}.*/i          if name_search

		if term_search
			select[:term] = term_search
		else
			select[:latest] = 1
		end

		select
	end

	def search_for_courses(query)
		sort = ["", "min_start ASC, ", "max_start DESC, ", "min_enroll ASC, "][(params["sort"] || 0).to_i]
		q = params_from_query(query, params["credits"] || 0, params["term"] || 0)
		results = Course.where(q)
		
		if params["rand"].presence
			results = results.only(:_id)
			random = Course.find(results.sample.id)
			return [random]
		else
			results = results.order_by("year DESC, term ASC, dept ASC, #{sort} number ASC")
		end

		params["capped"] = results.count == 150
		results
	end

	def index
		@query = params[:q].try(:strip)
		@courses = nil

		if (@query && !@query.empty?) || params["rand"].presence
			if @query.downcase == "register" || @query.downcase == "registrar"
				redirect_to "https://webreg.its.rochester.edu/prod/web/RchRegDefault.jsp"
				return
			end
			@courses = search_for_courses(@query)
		else
			@depts = Department.all
		end
	end
end
