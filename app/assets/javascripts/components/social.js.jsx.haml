(function() {
  var Button = ReactBootstrap.Button;

  window.Social = React.createClass({
    mixins: [Reflux.connect(SKScheduleStore, "store")],

    getInitialState: function () {
      return {
        checkedLoginState: false,
        fb_id: null,
        requests: this.props.requests,
        shareUsers: this.props.shareUsers,
        requested: this.props.requested,
        publicFriends: [],
        friends: [],
        nav: 0
      };
    },

    componentDidMount: function() {
      // So it can be accessed by the SDK
      window.afterLogIn = this.checkLoginState;
      var self = this;

      window.fbAsyncInit = function() {
        FB.init({
          appId      : '538742782963492',
          xfbml      : true,
          version    : 'v2.5'
        });

        self.checkLoginState();
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    },

    checkLoginState: function () {
      var self = this;
      FB.getLoginStatus(function(response) {
        if (response.status == 'connected') {
          //The person is logged into Facebook, and has logged into your app
          var id = response.authResponse.userID;
          FB.api(
            "/"+id,
            function (response) {
              if (response && !response.error) {
                if (!window.FBID2Name) {
                  window.FBID2Name = {};
                }
                window.FBID2Name[id] = response.name;
              }
            }
          );

          $.post("fb_register_user", {"id":id}, function (response) {
            SKScheduleAction.loadUser(response);
            self.setState({
              requests: response.requests,
              shareUsers: response.shareUsers,
              requested: response.requested
            });
          });

          self.setState({fb_id: id});

          self.getFriendsList();
        }
        else {
          self.setState({fb_id: null});

          if (response.status == 'not_authorized') {
          //The person is logged into Facebook, but has not logged into your app.
          }
          else if (response.status == 'unknown') {
            //The person is not logged into Facebook, so you don't know if they've logged into your app
          }
        } 
        self.setState({checkedLoginState: true});
      });
    },

    getFriendsList: function() {
      var self = this;
      FB.api("/me/friends",
        function (response)
        {
          if (response && !response.error) {
            self.setState({friends:response.data});

            window.FBFriends = response.data;
            if (!window.FBID2Name) {
              window.FBID2Name = {};
            }
            for (var i = 0; i < response.data.length; i++) {
              var user = response.data[i];
              window.FBID2Name[user.id] = user.name;
            }

            var event = new CustomEvent("gotFriendsList");
            document.dispatchEvent(event);

            $.get('fb_get_public_sharing_friends', {friends: response.data}, function (resp) {
              self.setState({publicFriends: resp.friends});
            })
          }
        }
      );
    },

    acceptRequest: function(req) {
      var self = this;
      $.post('fb_share_confirm', {sr_id:req.id}, function (data) {
        var index = self.state.requests.indexOf(req);
        self.setState({
          requests: ReactUpdate(self.state.requests, {$splice: [[index, 1]]}),
          shareUsers: data.shareUsers
        });
      });
    },

    sendRequest: function(friend) {
      var self = this;
      $.post("fb_share_request", {a:this.state.fb_id, b: friend.id}, function (data) {
        self.setState({
          requested: data.requested
        });
      });
    },

    unshare: function(friend_id) {
      var self = this;
      $.post("fb_unshare", {nonfriend: friend_id}, function (data) {
        self.setState({shareUsers: data.shareUsers});
      });
    },

    navState: function (nav) {
      this.setState({nav: nav});
    },

    renderNavTab: function (idx, contents) {
      return (~
        %li(className={this.state.nav == idx ? "active" : ""})
          %a(href="#" onClick={this.navState.bind(this, idx)})
            {contents}
      ~);
    },

    render: function() {
      if (!this.props.visible) {
        return null;
      }

      var self = this;

      // needs to be present when the FB API call is made to work, so we can't just add it in later
      // once it's needed, need to have it but hide it
      var showButton = (!self.state.checkedLoginState || self.state.fb_id) ? {display:"none"} : null;
      var loginButton = (~
        .social-login(style={showButton})
          .row
            .col-md-1
            .col-md-5
              %p.social-login-text
                Connect Skedge with Facebook to:
                %ul
                  %li Keep your schedule synced across devices
                  %li Keep up to date with your friends’ schedules
                  %li See friends’ names next to classes that they’re taking or have liked
              %p.social-login-text
                Skedge will 
                %strong
                  {" never:"}
                %ul
                  %li Post to Facebook without your permission
                  %li
                    Keep or store
                    %strong= {" any "}
                    of your Facebook data on its servers, not even your name
                    .fb-footnote
                      %small
                        Skedge only stores an anonymous ID uniquely generated by Facebook for Skedge per account.
                        Only users’ names are accessible via this ID, and Skedge does not even store them, your
                        own browser looks them up every time they are displayed.
                        %a.fb-check-source(href="https://github.com/RocHack/skedge")
                          {" [You can check the source code!]"}
            
            .col-md-1    
            .col-md-5
              .fb-login-button.login(data-max-rows="1"
                               data-size="xlarge"
                               data-show-faces="true"
                               data-onlogin="afterLogIn();"
                               scope="user_friends"
                               data-auto-logout-link="false")
      ~);

      var others = null;
      var requests = null;
      var schedules = null;

      if (this.state.fb_id && window.FBID2Name) //has friends downloaded
      {
        requests = (~
          %SocialRequests(requests={this.state.requests} parent={this})
        ~);

        schedules = (~
          %SocialSchedules(shareUsers={this.state.shareUsers}
                           publicFriends={this.state.publicFriends}
                           parent={self})
        ~);

        var otherFriends = this.state.friends.filter(function (friend) {
          var r = self.state.requests && self.state.requests.some(function (req) { return req.from == friend.id; });
          var s = self.state.shareUsers && self.state.shareUsers.some(function (sf) { return sf.fb_id == friend.id; });
          return !r && !s;
        });

        others = (~
          %SocialUnconnected(otherFriends={otherFriends}
                             parent={this}
                             requested={self.state.requested}
                             publicFriends={self.state.publicFriends})
        ~);
      }

      var scheduleURL = "http://skedgeur.com/";
      if (this.state.store.schedule) {
        scheduleURL += this.state.store.schedule.rid;
      }
      var showNoFriends = (this.state.fb_id && window.FBID2Name && !requests && !shares && !publics && !others) ? null : {display:"none"};
      var noFriends = (~
        .social-no-friends(style={showNoFriends})
          %p
            You have no friends using Skedge!
          %p
            Share your schedule and spread the word!
          %p
            .fb-share-button(data-href={scheduleURL} data-layout="button")
      ~);

      var logout = (~
        .fb-login-button.logout(data-max-rows="1"
                         data-size="medium"
                         data-show-faces="false"
                         data-onlogin="afterLogIn();"
                         scope="user_friends"
                         data-auto-logout-link="true"
                         key="logout")
      ~);

      var showMyself = (self.state.fb_id && window.FBID2Name && window.FBID2Name[self.state.fb_id]) ? null : {display:"none"};
      var myself = (~
        .fb-myself(style={showMyself})
          %FacebookUser(id={self.state.fb_id} linesUnderneath={[logout]})
      ~);

      var numRequests = this.state.requests ? this.state.requests.length : null;

      var page = [schedules, requests, others, null][this.state.nav];

      var requestsTab = (~
        .
          Share requests
          %span.badge.nav-badge
            {numRequests}
      ~);

      var unconnectedTab = (~
        .
          Unconnected friends
          %span.badge.nav-badge
            {others ? others.length : null}
      ~);

      return (~
        .social-container

          .social-head
            .social-splash
              %i.fa.fa-globe
              skedge social
            {myself}
          
          {loginButton}

          {noFriends}

          %ul.nav.nav-tabs
            {this.renderNavTab(0, "Schedules")}
            {this.renderNavTab(1, requestsTab)}
            {this.renderNavTab(2, unconnectedTab)}
            {this.renderNavTab(3, "Settings")}

          .social-contents
            {page}
      ~);
    }
  })
})();