DATA = '__LASTFOCUS=&__EVENTTARGET=ctl00%24MainContentArea%24btnSearch&__EVENTARGUMENT=&__VIEWSTATE=uX2whDNV%2BVBej1QodNj%2FSXZRvFuLz%2BoZZn8H82N7XBud56YD57sFxXZSXq2RRpLLj98HEZ0MhV7HN8rDZ%2BV0KY4t4AzrKoS6TN2zle7fgkibRtkEq1YGXBCOIVJVOe%2FRePzb71UoHTM5%2Bx9cWeYiR%2BvjMlDib0ti%2F2DLLoYgWaBi2FLVZc1xka1j7IB6n5zZlhdckMnk3bGRPsUa9wiqUYSUD2vqbSlc%2FTeX8H4bru33gh26uARjTsLPl9yg4m89kKy89RAfxhJMW5eD%2BQhAWO1SGTlmffnOhIgJIR61J5Skqc0Zb8opIdLXgMIbglU4D3euD12P0TELp19FA1D4NVAByOmLsDrrhIFrc%2FikDkcUKuL3fzsSiT4dyyQ2W6oRvtNfHWQf73hI12pA1KuoNT1rq%2BM%2B2RrC9G667TAcvbcltJBWHVHagGpkkcM2TEEArzuorkSrRWBZ8Sxaclur14lKxZuISEkt%2B8C2EDMUmy4vebqgpvlrGZIi2tmKuRMHDJ%2FAAn8mlqMSHPhbcsQsZ0I%2BUB89A%2FC6xzS%2BqZCzP7KoUKLsL8p5UUHsgXR2ExytfKkJYX1K6k%2F%2FHWQtE0pytPTq6BBGGZK2T1sju5U6IjT4dVGHa5kh6PpKUQWvpq033iUTq12pUbHA6I9SoVxm4i2pgrqkFABwNtmZDpZKAd%2BJRgBRdgQ8HbRDC5KVADJjnMkH07K5ZzJBsTFkOaAq2F34Ev6TjK1Xc03v%2FSPkawOZl61EebYa4mDNQqKUbH1DmViRoZpb%2BE8cR7vgveYW94qYBXFYQcuseCi4BkB8sWBj3FbujqJZQR9MbLtTbiqcyfaOQZ2Bs7p4WL6LPgfpQEjj705nLDdzJ4F8NF0xPtNWpN4dRq%2FmPwUx8PQG9Qbbwr1i43oC8mxb7dfCccQuEAQxBh8oat93Mk27%2BRd5UvqVH1pPqxmuUVon%2BvtRdF3yYUnMXG%2BKNcU%2BSnPBWiqmEjLXf1OqvMd6f8Sx7%2Fp7wAfgqXtDlDhZP%2BgbqjPggU%2B1azKZdbmWXR6P%2F9m1RowaVJhShbVsu8lGRO3PT6zdoJZwj6EPC7Q3Roqdnc9teyNJhSpe%2F23MfHt9fugynGOmgHNnLQo36%2FPc3W6dhaeLHwTj20bWo2RIAna8uBGJVlVkameeWKDyRmooFVOh4NCDELju5pGu8WgMC6aunHlmvCW7r0wQ4KeTErN5VRKPI1WQald50Fb3CPz72w3qWtbQC1c2TdpTrGgUxd9NWBUL84A3%2FJT2x3IqCoLgwAuaboStLQ54zPxDI8R2RMe8Y9IZYXw8XxNva3%2FR3nNV2mIOcHKdBxD8gE0Zka6eVLz4QesGU5gqzrTVd4AxuFt0R5qEXz2m0figXe7sPkctr%2FxmXJYRxV2QphdyR0LHbOd6fhnkk%2Bse817h9Fok5C4m3Hhfx9J0wjinbMNohdlPmmAOY%2Fi5ZuKhmvrtj3w6sNRygALHzUt5FoWJF4V7ZE9IFoeFmmAxU7p8nRnHVAf1mD9zfR7jK99ACzXxkiQuidFl0Db9NacyHs8uoUHPVdz44bLuzWFupLVCo8DH7nwmGI7RC0PaTn6S8uyXPMcq%2BZHdWXQ%2Fl7YVHdt9WQUxYwWaKw5%2BW4nkOIMkspAcm9SsnUUUaJxqGTBiIZOHCui9Xh8MJzabisOFjpAf9Eqkjb6vvVno7YLhxU6n9XffMVghu7ubTjqpnIqPZxaSZB5ae%2B18dQXoXyRMnfYV3ICpyd6Ahwz4iGiaeqRbL7rGjBgLY%2Bx2nA4Zy6K7qPzV7wt8vUcDJKTKqLVtbxuz%2BkYcmfnkQ%2BcrQXVZGb38HySMEYGaY9s0g4sh1lQCFguN8Cxx%2BGML9FVeIsHfAKgnH9MvTgxzm0Ia%2F8WPke0D6qBO9J0H4ipfmNrkZohe6gqw6EoExHGz%2Bn7rhM00uZScY6xCMiQvn2beWdwNMgo6oPOQ0%2BI0iTX7Nt9Ow0Sg3xRmRfULWwkcQuk7XhsoHXjTWwQ8HVFJpepCUlsAnV0JJtGBJigwLtt9i9RNiNtrW3vPL5JO%2FFIstC1UBZN0Cy9DD1hicThWIC1KO9qmG0R2cSdKCOur6dDMN1UjL5ARUDkdfsruIk5X%2BuIvJVhhtw%3D%3D&__VIEWSTATEENCRYPTED=&__EVENTVALIDATION=9mq%2BT%2BK7Fl5dm90Yplit0yCVulECicIf5bGq0mMYDTGHn9BuPVnyf44vumvIOv6PusxFcvtz84m8qNu76pkZncf4wrULTA1%2B0QDHUGE3%2Bzvvp4Mf2mSr1QpfRBN7VGBCP1RmpUCADaiaV7vGOTqFrF%2FkWtRAx327eVl%2FhYTMUEkpAuPz&ctl00%24MainContentArea%24txtNETID=&ctl00%24MainContentArea%24txtPassword=&ctl00%24MainContentArea%24txtDepartment=&ctl00%24MainContentArea%24txtPhone=&ctl00%24MainContentArea%24txtEmail=&ctl00%24MainContentArea%24txtName='

class MainController < ApplicationController
	def get_email
		response = HTTParty.post('https://info.rochester.edu/FacultyStaffDirectory/Default.aspx', :body => DATA+params["email"])
		if match = response.parsed_response.match(/(JpegImage\.ashx\?text=[A-Z0-9]+)/)
			img = "https://info.rochester.edu/FacultyStaffDirectory/"+match[1]
			render json:{"url" => img}
		else
			render status:404
		end
	end

	def rand_order
		Rails.env.production? ? "RAND()" : "RANDOM()"
	end

	def spring?
		true
	end

	def all_depts
		@@all ||= Department.all
	end

	def lookup_dept(txt)
		all_depts.find do |d|
			d.short == txt.upcase
		end
	end

	def do_search(type_search, status_search, name_search, dept_search, num_search, instructor_search, term_search, c_low, c_hi, sort)
		Course.limit(150).joins{department}.where do
			[
				c_low.presence && credits >= c_low,
				c_hi.presence && credits <= c_hi,
				num_search.presence && num =~ "#{num_search}%",
				term_search.presence && term == term_search,
				name_search.presence && name =~ "%#{name_search}%",
				dept_search.presence && department_id == dept_search,
				type_search.presence && course_type == type_search,
				instructor_search.presence && instructors =~ "%#{instructor_search}%"
			].compact.reduce(:&)
		end.includes({sections:[:course], labs:[:course], recitations:[:course], workshops:[:course], lab_lectures:[:course], sister_course:[]}).order("year DESC, term #{spring? ? "DESC" : "ASC"}, department_id, #{sort}")
	end

	def credits_range(search)
		case search
		when "Any"
			return nil, nil
		when "1-2"
			return 1, 2
		when "3-4"
			return 3, 4
		when "5+"
			return 5, nil
		end
	end

	def search_for_courses(query)
		puts  "\n\n****** SEARCHING ******\n\n"


		type_search = Course::Type::Course
		status_search = nil
		name_search = nil
		dept_search = nil
		num_search = nil
		instructor_search = nil

		term_search = Course::Term::Terms[params["term"].try(:capitalize)]
		credits_search = params["credits"]
		sort = {"Course #"=>"num", 
				"Start time (early to late)" => "min_start_time ASC", 
				"Start time (late to early)" => "max_start_time DESC", 
				"Class size (small to large)" => "min_enroll ASC"}[params["sort"]] || "num"

		instructor_regex = /instructor:\s*([A-Za-z'-_]*)/i
		if (match = query.match instructor_regex)
			instructor_search = match[1]
			params[:instructor_search] = instructor_search #keep so the view can filter out sections
			query = query.gsub(instructor_regex,"").strip #remove from the query
		end

		name_search = query
		match = query.match /^([A-Za-z]*)\s*(\d+[A-Za-z]*|)\s*$/
		if match && (match[1].size <= 3 || !match[2].empty?) #either the dept length is <= 3 OR we have some numbers
			dept_short = match[1] if !match[1].empty?
			d = nil
			if !dept_short || dept_short.empty? || d = lookup_dept(dept_short)
				dept_search = d.try(:id)
				name_search = nil
			end
			num_search = match[2] if !match[2].empty?
		end

		c_lo, c_hi = credits_range(params["credits"])
		non_cancelled = (sort == "min_enroll ASC")
		s = do_search(type_search, status_search, name_search, dept_search, num_search, instructor_search, term_search, c_lo, c_hi, sort)
		if params["random"].presence
			s = s.limit(1).order(rand_order)
		end
		params["capped"] = s.count == 150
		s.delete_if do |x|
			x.cancelled?
		end if non_cancelled
		s
	end

	def filter(courses)
		#TODO optimize, maybe?
		courses.compact.delete_if do |c|
			sister = c.sister_course
			sister_exists = sister && (c.year < sister.year || (c.year == sister.year && c.term > sister.term)) && courses.include?(sister)
			sister_exists || c.research?
		end
	end

	def index
		@query = params[:q].try(:strip)
		@courses = nil

		if @query && !@query.empty?
			if @query.downcase == "register" || @query.downcase == "registrar"
				redirect_to "https://webreg.its.rochester.edu/prod/web/RchRegDefault.jsp"
				return
			end
			@courses = filter(search_for_courses(@query))
		elsif params["random"].presence
			#random everything, but include stuff
			term_search = Course::Term::Terms[params["term"].try(:capitalize)]
			c_lo, c_hi = credits_range(params["credits"])
			@courses = Course.limit(1).where do
				[
					term_search.presence && term == term_search,
					c_lo.presence && credits >= c_lo,
					c_hi.presence && credits <= c_hi,
					course_type == Course::Type::Course,
					desc != nil
				].compact.reduce(:&)
			end.order(rand_order)
		else
			@depts = all_depts
		end
	end
end
