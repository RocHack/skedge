(function() {
  var Button = ReactBootstrap.Button;
  var Tooltip = ReactBootstrap.Tooltip;
  var OverlayTrigger = ReactBootstrap.OverlayTrigger;
  var Popover = ReactBootstrap.Popover;

  window.SearchBar = React.createClass({
    mixins: [Reflux.connect(SKScheduleStore, "store"),
             Reflux.connect(SKSocialStore, "social")],

    seeSearchTips: function () {
      if (link = document.getElementById('search-link')) {
        link.click();
      }
    },

    logoClick: function () {
      if (splash = document.getElementById('splash-logo')) {
        splash.click();
      }
    },

    clickSocial: function (dismiss) {
      ahoy.track("$click",{name:"social-globe", badge:this.state.social.requests.length});
      document.cookie = "social_popup=true;"
      document.location = "/social";
    },

    render: function() {
      var logoHref = document.getElementById('splash-logo') ? "#" : "/";
      
      var searchHelpOverlay = (~
        %Tooltip
          see ways to search with skedge
      ~);

      var bookmarksOverlay = (~
        %Tooltip
          see my bookmarks
      ~);

      var sideBtn;
      var searchPlaceholder;
      if (!mobilecheck()) {
        searchPlaceholder = "CSC / CSC 171 / Science of Programming";
        sideBtn = (~
          %span.input-group-btn.search-button
            %button.input-lg.btn.btn-default.btn-gray(type="submit")
              %span.fa.fa-search
        ~);
      }
      else {
        searchPlaceholder = "CSC / CSC 171 / Science...";
        sideBtn = (~
          %span.input-group-btn
            %button.input-lg.btn.btn-default#schedule-btn(disabled={!this.state.store.schedule})
              %i.fa.fa-calendar
        ~);
      }

      var badge = (this.state.social.requests.length == 0) ? null : (~
        %span.badge.badge-notifications
          {this.state.social.requests.length}
      ~);

      var callout = (~
        .(hidden={true})
          #social-callout
            .social-callout-body
              .social-callout-icons
                %i.fa.fa-refresh
                %i.fa.fa-calendar-check-o
                %i.fa.fa-thumbs-o-up
                %i.fa.fa-lock
              %strong Connect Skedge with Facebook!
              %p
                – Sync your schedule across devices
                %br
                – See what your friends are taking!
              %Button#social-callout-tryit(bsStyle='primary')
                Try it or learn more!
              %Button#social-callout-dismiss
                Dismiss
      ~);

      var subtlerCalloutStuff = !this.state.social.ready || this.state.social.loggedIn ? null : (~
        %span
          .gps-container
            .gps-ring
          .label.label-danger.label-small
            New!
      ~);

      var social = mobilecheck() ? null : (~
        .
          {callout}
          %Button.social-btn(bsStyle="link" onClick={this.clickSocial})
            %i.fa.fa-globe.searchbar-globe(data-container="body"
                                           data-toggle="popover"
                                           data-placement="bottom"
                                           data-trigger="manual")
            {badge}
            {subtlerCalloutStuff}
      ~);

      var numBookmarks = this.state.store.bookmarks.length;
      if (numBookmarks == 0) numBookmarks = null;
      if (numBookmarks > 9) numBookmarks = (~ %i.fa.fa-archive ~);

      return (~
        %form(action=".")
          .head-fixed
            .logo-panel
              %a.logo(href={logoHref}
                      onClick={this.logoClick}
                      name="logo")
                %h1.logo
                  skedge

            {social}

            .input-group
              %input.form-control.input-lg#search-bar(name="q"
                                                      type="search"
                                                      placeholder={searchPlaceholder}
                                                      defaultValue={this.props.query}
                                                      onFocus={this.seeSearchTips})

              %i.fa.fa-search.form-control-feedback.mobile

              %a(href="/?q=bookmarks")
                %OverlayTrigger(overlay={bookmarksOverlay} placement="bottom")
                  %span.glyphicon.glyphicon-bookmark.search-bkmk
                    %span.num-bookmarks
                      {numBookmarks}

              %a(href="/#search"
                 name="search-help"
                 onClick={this.seeSearchTips})
                %OverlayTrigger(overlay={searchHelpOverlay} placement="bottom")
                  %i.fa.fa-question-circle.search-help
              
              {sideBtn}
      ~);
    }
  })
})();
